import numpy as np
import pytest
from tempo_embeddings.embeddings.model import RobertaModelWrapper
from tempo_embeddings.text.corpus import Corpus
from tempo_embeddings.text.corpus import TokenInfo
from tempo_embeddings.text.passage import Passage


class TestRobertaModelWrapper:
    @pytest.mark.integration
    @pytest.mark.slow
    @pytest.mark.parametrize(
        "model_name, text, char_span, expected",
        [
            (
                "roberta-base",
                "This is a test text.",
                TokenInfo(5, 7),
                [
                    0.254973441362381,
                    0.2825826406478882,
                    0.20558702945709229,
                    0.05396515130996704,
                    0.4300648272037506,
                    0.5010359287261963,
                    -0.11960853636264801,
                    -0.0664907693862915,
                    0.1450442671775818,
                    -0.05392435938119888,
                    -0.16991479694843292,
                    0.1902831792831421,
                    0.26095426082611084,
                    0.0849054828286171,
                    0.1840103566646576,
                    -0.6597312688827515,
                    0.13361340761184692,
                    -0.3290926516056061,
                    0.2966518998146057,
                    0.16179299354553223,
                    -0.17462560534477234,
                    0.4033777117729187,
                    0.09303416311740875,
                    0.03639363870024681,
                    -0.2385300099849701,
                    0.4054151475429535,
                    -0.13389697670936584,
                    -0.11863644421100616,
                    -0.29279327392578125,
                    0.08918264508247375,
                    -0.09756225347518921,
                    0.12277226150035858,
                    0.24591514468193054,
                    0.20860253274440765,
                    -0.23924270272254944,
                    0.07770927250385284,
                    -0.07088130712509155,
                    -0.11010599136352539,
                    0.6926469206809998,
                    0.06116428226232529,
                    0.2462429404258728,
                    -0.261435866355896,
                    -0.3514586091041565,
                    -0.03629846125841141,
                    0.045755840837955475,
                    -0.21769249439239502,
                    -0.015655778348445892,
                    0.11847016215324402,
                    0.04360724985599518,
                    -0.037060074508190155,
                    -0.032625630497932434,
                    0.08067446947097778,
                    -0.00531751848757267,
                    0.2729664742946625,
                    0.061775270849466324,
                    0.05893227830529213,
                    0.17661982774734497,
                    -0.22297579050064087,
                    -0.09652264416217804,
                    -0.09815956652164459,
                    -0.19241870939731598,
                    -0.7737542390823364,
                    -0.11370840668678284,
                    0.04674438014626503,
                    0.14681056141853333,
                    -0.26735547184944153,
                    0.2438979297876358,
                    0.2659900188446045,
                    -0.06676340103149414,
                    -0.007830698043107986,
                    -0.30594852566719055,
                    0.0006017442792654037,
                    -0.0774383544921875,
                    -0.242068350315094,
                    0.14580059051513672,
                    -0.15182344615459442,
                    0.3475770056247711,
                    -6.645754814147949,
                    -0.3876032829284668,
                    0.2007574737071991,
                    0.05790332704782486,
                    0.11258551478385925,
                    0.7235205769538879,
                    -0.09126321971416473,
                    0.018776338547468185,
                    -0.5276330709457397,
                    0.27254387736320496,
                    -0.1324251890182495,
                    0.018265021964907646,
                    -0.0615682378411293,
                    -0.12802204489707947,
                    0.1390676498413086,
                    0.07214342057704926,
                    -0.3681642711162567,
                    0.09662289172410965,
                    0.0013138949871063232,
                    -0.16838842630386353,
                    0.7970330715179443,
                    -0.07262304425239563,
                    -0.25679248571395874,
                    -0.16130220890045166,
                    -0.0937538594007492,
                    0.5423139333724976,
                    0.17633283138275146,
                    0.0265297032892704,
                    0.18558280169963837,
                    0.11859224736690521,
                    -0.20601224899291992,
                    -0.04682927578687668,
                    0.10856328159570694,
                    0.3436392545700073,
                    0.4612812399864197,
                    0.12142431735992432,
                    -0.05593329668045044,
                    0.050098542124032974,
                    -0.014824045822024345,
                    0.32367071509361267,
                    0.15562406182289124,
                    0.1159893348813057,
                    0.355760782957077,
                    -0.11182218790054321,
                    -0.09079588949680328,
                    -0.03889282047748566,
                    -0.15513333678245544,
                    0.16488605737686157,
                    -0.038501910865306854,
                    0.08333887159824371,
                    0.07403668761253357,
                    -0.06679081171751022,
                    0.18233154714107513,
                    0.0718379095196724,
                    -1.056429147720337,
                    0.04051240533590317,
                    -0.07650461792945862,
                    0.2224373072385788,
                    0.13250674307346344,
                    -0.07034000754356384,
                    0.02450191229581833,
                    -0.15071852505207062,
                    -0.2886076271533966,
                    0.09824877977371216,
                    -0.17246484756469727,
                    0.28938812017440796,
                    -0.17544858157634735,
                    0.5080807209014893,
                    0.1524772047996521,
                    -0.019477657973766327,
                    0.06688756495714188,
                    0.07883936166763306,
                    -0.02662806399166584,
                    0.20200283825397491,
                    -0.1864449828863144,
                    0.06239182874560356,
                    0.11847347021102905,
                    0.22812552750110626,
                    0.5811170935630798,
                    -0.14586113393306732,
                    -0.09592249989509583,
                    0.28593820333480835,
                    0.632835328578949,
                    0.25648099184036255,
                    0.009744567796587944,
                    0.5235370993614197,
                    -0.35309046506881714,
                    0.00010068342089653015,
                    0.06644311547279358,
                    -0.1627342849969864,
                    -0.1852853000164032,
                    -0.2632850110530853,
                    0.026663653552532196,
                    -0.14425811171531677,
                    0.3281308710575104,
                    0.010091929696500301,
                    -0.2529394328594208,
                    -0.2178240716457367,
                    -0.030045844614505768,
                    0.36431214213371277,
                    0.15870799124240875,
                    0.009923961013555527,
                    -0.12397587299346924,
                    -0.06522022932767868,
                    0.15848572552204132,
                    0.03990272060036659,
                    -0.16565707325935364,
                    0.04206344857811928,
                    0.24368123710155487,
                    0.3413504660129547,
                    0.1232491210103035,
                    -0.3513587415218353,
                    0.12707659602165222,
                    0.2109120786190033,
                    0.22178466618061066,
                    -0.06569191813468933,
                    0.02071589231491089,
                    0.15747994184494019,
                    0.18372021615505219,
                    -0.035227496176958084,
                    0.0860888734459877,
                    0.21575215458869934,
                    -0.14792920649051666,
                    -0.07607554644346237,
                    0.012727335095405579,
                    -0.07346075028181076,
                    0.23139256238937378,
                    0.0583353266119957,
                    -0.1380200982093811,
                    -0.18212799727916718,
                    -0.015206560492515564,
                    0.20248226821422577,
                    -0.1765946000814438,
                    -0.05044139176607132,
                    -0.024317800998687744,
                    -0.012559734284877777,
                    -0.01658184453845024,
                    -0.09731300175189972,
                    0.04930457845330238,
                    0.05084412172436714,
                    -0.6073797345161438,
                    0.31805598735809326,
                    0.30547717213630676,
                    0.2645300626754761,
                    0.14770351350307465,
                    -0.12727531790733337,
                    -0.024797484278678894,
                    -0.3128719925880432,
                    0.35464051365852356,
                    0.23303571343421936,
                    -0.2552553713321686,
                    0.19466349482536316,
                    0.2689077854156494,
                    -0.0016220919787883759,
                    -0.12393121421337128,
                    -0.1521751582622528,
                    -0.045560531318187714,
                    0.18890099227428436,
                    -0.06283068656921387,
                    0.11630555242300034,
                    0.20605848729610443,
                    0.035154495388269424,
                    0.06039338558912277,
                    0.35560521483421326,
                    0.08523033559322357,
                    -0.12775659561157227,
                    -0.010670550167560577,
                    -0.12896810472011566,
                    -0.7051591277122498,
                    -0.02634793519973755,
                    0.22633756697177887,
                    0.1344699263572693,
                    -0.14612066745758057,
                    -0.1217460185289383,
                    -0.01587039977312088,
                    0.23965279757976532,
                    0.04337051510810852,
                    0.011556299403309822,
                    -0.32821500301361084,
                    -0.29630640149116516,
                    -0.06983025372028351,
                    -0.3918602764606476,
                    0.6411445140838623,
                    -0.19626019895076752,
                    -0.13414302468299866,
                    0.48464682698249817,
                    -0.11377038061618805,
                    0.03842899575829506,
                    0.3392326235771179,
                    -0.08088284730911255,
                    0.010885840281844139,
                    -0.07296544313430786,
                    0.15193407237529755,
                    -0.17680442333221436,
                    0.057273462414741516,
                    0.10048586130142212,
                    0.04280996322631836,
                    -0.04073762148618698,
                    -0.15245288610458374,
                    0.052114252001047134,
                    -0.20918071269989014,
                    0.3148755729198456,
                    0.06576544046401978,
                    0.18902598321437836,
                    -0.19401110708713531,
                    -0.1265186071395874,
                    -0.09284013509750366,
                    0.12373729050159454,
                    0.010380163788795471,
                    -0.23821300268173218,
                    0.2088211476802826,
                    -0.03698137402534485,
                    -0.0356881245970726,
                    0.17989909648895264,
                    0.08242645859718323,
                    -0.05133502185344696,
                    -0.05378315597772598,
                    -0.038049887865781784,
                    -0.09582959115505219,
                    0.04840557277202606,
                    -0.238337904214859,
                    0.36646968126296997,
                    0.08929017931222916,
                    0.20425061881542206,
                    0.4187825918197632,
                    0.3350274860858917,
                    -0.0014639776200056076,
                    -0.2560628354549408,
                    -0.23299774527549744,
                    0.046847693622112274,
                    -0.04001142084598541,
                    -0.1626996397972107,
                    -0.011222884058952332,
                    0.19151626527309418,
                    -0.28105294704437256,
                    -0.029417119920253754,
                    0.10435447096824646,
                    0.021106377243995667,
                    -0.15123490989208221,
                    0.2451278120279312,
                    0.29537150263786316,
                    0.12216383963823318,
                    -0.1800408959388733,
                    0.10253521054983139,
                    0.006758730858564377,
                    -0.25963181257247925,
                    0.04118772968649864,
                    0.042364850640296936,
                    0.11775095760822296,
                    -0.2776823043823242,
                    -0.23267516493797302,
                    0.36283954977989197,
                    0.1980167031288147,
                    1.2093911170959473,
                    1.616792917251587,
                    0.235901340842247,
                    0.06108158454298973,
                    0.0947117805480957,
                    -0.16452860832214355,
                    -0.20861023664474487,
                    0.12406086921691895,
                    0.09620247036218643,
                    0.3186204731464386,
                    -0.15585243701934814,
                    -0.09018092602491379,
                    -0.2520890533924103,
                    0.010946355760097504,
                    0.13033655285835266,
                    -0.011238861829042435,
                    0.09491387754678726,
                    -0.09311502426862717,
                    0.20760232210159302,
                    -0.6074942350387573,
                    -0.1915002167224884,
                    -0.2081851065158844,
                    0.22498087584972382,
                    0.16976572573184967,
                    -0.04178016632795334,
                    -0.3890032172203064,
                    0.21452124416828156,
                    -0.04640874266624451,
                    -0.05025152862071991,
                    0.44789227843284607,
                    0.2574574947357178,
                    0.5777018070220947,
                    0.2272024303674698,
                    -0.24436646699905396,
                    -0.4355241656303406,
                    0.3166983425617218,
                    0.26317092776298523,
                    0.25651323795318604,
                    -0.08224322646856308,
                    -0.14918358623981476,
                    0.12221011519432068,
                    -0.13607405126094818,
                    -0.1680746227502823,
                    0.01591472700238228,
                    0.07397960126399994,
                    -0.03410995006561279,
                    0.4008697271347046,
                    -0.1829225718975067,
                    0.08448100090026855,
                    -0.08770880103111267,
                    -0.1378522366285324,
                    0.06514081358909607,
                    -0.1146228015422821,
                    -0.048296235501766205,
                    0.051269471645355225,
                    -0.035676613450050354,
                    -0.2929038107395172,
                    0.06878019869327545,
                    0.21342316269874573,
                    0.008613718673586845,
                    0.004309181123971939,
                    0.14156891405582428,
                    -0.18432709574699402,
                    0.27965813875198364,
                    0.04650264233350754,
                    0.22151291370391846,
                    -0.15081660449504852,
                    -0.25079530477523804,
                    0.35619625449180603,
                    -0.020072847604751587,
                    -0.026085875928401947,
                    0.006940804421901703,
                    0.07897226512432098,
                    0.360247403383255,
                    -0.3779611885547638,
                    -0.18641752004623413,
                    -0.1290004551410675,
                    -0.101532943546772,
                    0.108420230448246,
                    0.05793222039937973,
                    -0.08134039491415024,
                    -0.18764378130435944,
                    0.13111251592636108,
                    0.026631753891706467,
                    -0.15071173012256622,
                    -0.07611046731472015,
                    0.26270022988319397,
                    0.17729905247688293,
                    -0.032225459814071655,
                    -0.0268285870552063,
                    -0.5192556977272034,
                    0.08998600393533707,
                    -0.05708697438240051,
                    -0.038274019956588745,
                    -0.07179447263479233,
                    0.3069233298301697,
                    -0.029837682843208313,
                    -0.08127269893884659,
                    -0.109527587890625,
                    -0.015363931655883789,
                    -0.30817562341690063,
                    -0.021658554673194885,
                    0.19023358821868896,
                    -0.017789997160434723,
                    -0.14210818707942963,
                    -0.08808542788028717,
                    0.044094450771808624,
                    0.023421313613653183,
                    0.2533832788467407,
                    0.02698582597076893,
                    -0.001347854733467102,
                    -0.16302509605884552,
                    0.059515759348869324,
                    -0.008759334683418274,
                    0.05662001296877861,
                    -0.03667914867401123,
                    -0.40246182680130005,
                    0.036610063165426254,
                    0.24485346674919128,
                    -0.21368354558944702,
                    -0.012056972831487656,
                    -0.024299584329128265,
                    -0.2410452663898468,
                    -1.7330714464187622,
                    0.025187142193317413,
                    0.18949857354164124,
                    0.16651877760887146,
                    0.06569216400384903,
                    -0.20922255516052246,
                    -0.014357604086399078,
                    -0.2139514684677124,
                    0.07418851554393768,
                    0.06536269187927246,
                    -0.051452964544296265,
                    -0.054349176585674286,
                    -0.47373849153518677,
                    0.08949511498212814,
                    0.2588884234428406,
                    0.296140193939209,
                    0.4717901349067688,
                    0.1527310162782669,
                    -0.09172934293746948,
                    -0.0935070812702179,
                    -0.529281735420227,
                    0.03352656215429306,
                    0.09417464584112167,
                    -0.05718701332807541,
                    0.11214928328990936,
                    0.48840633034706116,
                    0.22017288208007812,
                    0.12744416296482086,
                    -0.30421847105026245,
                    -0.053114570677280426,
                    -0.029158659279346466,
                    -0.03317863866686821,
                    -0.008395828306674957,
                    0.1669902801513672,
                    0.1294649839401245,
                    0.5295755863189697,
                    -0.07422803342342377,
                    0.32434388995170593,
                    -0.3259856402873993,
                    0.18308128416538239,
                    0.1305808573961258,
                    0.15411484241485596,
                    -0.06049032509326935,
                    -1.3072861433029175,
                    0.06519793719053268,
                    -0.14567570388317108,
                    0.1190924420952797,
                    -0.15030094981193542,
                    -0.0005505494773387909,
                    0.0639890730381012,
                    -0.004535797983407974,
                    0.22848102450370789,
                    0.06784684956073761,
                    -0.2442854642868042,
                    0.07644940912723541,
                    0.3291015923023224,
                    0.010970298200845718,
                    0.25916731357574463,
                    -0.26921546459198,
                    0.11475992202758789,
                    0.03394374996423721,
                    -0.16554902493953705,
                    0.23203366994857788,
                    0.11454765498638153,
                    0.043963685631752014,
                    0.0862773135304451,
                    -0.4041828215122223,
                    -0.11875809729099274,
                    0.035863712430000305,
                    -0.14887389540672302,
                    0.10829143226146698,
                    0.39477813243865967,
                    0.25666677951812744,
                    -0.24676108360290527,
                    -0.12052460014820099,
                    0.28692951798439026,
                    -0.16827160120010376,
                    -0.04699185490608215,
                    -0.15654583275318146,
                    -0.022100679576396942,
                    0.004727434366941452,
                    -0.38877177238464355,
                    -0.221134752035141,
                    -0.1643075793981552,
                    -0.004898283630609512,
                    -0.17029911279678345,
                    -0.198506161570549,
                    0.09899456053972244,
                    -0.10768939554691315,
                    0.11969835311174393,
                    0.255435585975647,
                    0.024314891546964645,
                    -0.1640680730342865,
                    -0.1529320776462555,
                    -0.289348840713501,
                    0.05033474043011665,
                    0.10505358129739761,
                    -0.10297459363937378,
                    -0.5798115134239197,
                    0.27315786480903625,
                    0.17654825747013092,
                    0.13851997256278992,
                    -0.12762600183486938,
                    0.06603444367647171,
                    -0.14310342073440552,
                    -0.2842143177986145,
                    0.19793032109737396,
                    0.1907813996076584,
                    0.22928962111473083,
                    -0.3688177168369293,
                    -0.10913260281085968,
                    0.16931718587875366,
                    -0.08539295196533203,
                    -0.041433051228523254,
                    0.04559390991926193,
                    0.2024296522140503,
                    -0.012047860771417618,
                    -0.696329653263092,
                    -0.19049327075481415,
                    0.037228357046842575,
                    -0.3535349369049072,
                    -0.0555587112903595,
                    0.1080012395977974,
                    0.08266916871070862,
                    0.10040755569934845,
                    -0.08382465690374374,
                    -0.09256201982498169,
                    -0.21915960311889648,
                    -0.24191024899482727,
                    -0.016772188246250153,
                    -0.05068989843130112,
                    0.2545652985572815,
                    0.41970667243003845,
                    -0.3034076392650604,
                    0.2953224182128906,
                    11.02514362335205,
                    0.03793072700500488,
                    -0.11818456649780273,
                    0.22604550421237946,
                    -0.07780758291482925,
                    0.16303691267967224,
                    0.13159717619419098,
                    0.2818368673324585,
                    -0.05032002925872803,
                    0.24435870349407196,
                    0.11376067250967026,
                    0.27618640661239624,
                    0.006641947664320469,
                    -0.07504018396139145,
                    0.1003865897655487,
                    -0.23977181315422058,
                    0.15416738390922546,
                    -0.14236855506896973,
                    -0.19567552208900452,
                    -0.010067164897918701,
                    -0.23500293493270874,
                    0.28401419520378113,
                    0.250156044960022,
                    0.43181517720222473,
                    -0.16631962358951569,
                    -0.023536942899227142,
                    0.09307058900594711,
                    0.08347789198160172,
                    0.10827324539422989,
                    -0.07315757870674133,
                    -0.2807421386241913,
                    -0.16846886277198792,
                    -0.13629016280174255,
                    -0.08400943875312805,
                    0.21196964383125305,
                    0.3259526491165161,
                    -0.021486369892954826,
                    -0.05774307996034622,
                    -0.16695275902748108,
                    -0.2538162171840668,
                    -0.05906710773706436,
                    -0.0021618157625198364,
                    -0.0066642798483371735,
                    0.40674927830696106,
                    0.1906903237104416,
                    -0.036302968859672546,
                    0.06774187088012695,
                    0.31792402267456055,
                    0.014771051704883575,
                    0.0631570816040039,
                    -0.1880086362361908,
                    -0.01599491387605667,
                    0.07091215997934341,
                    0.531997799873352,
                    -0.2165846824645996,
                    0.023576103150844574,
                    0.11350587755441666,
                    0.05834049731492996,
                    0.0924709141254425,
                    -0.646880030632019,
                    0.2507230043411255,
                    0.10515265166759491,
                    0.07999742031097412,
                    0.3427758812904358,
                    0.48459023237228394,
                    0.18498139083385468,
                    -0.07706022262573242,
                    0.05717718228697777,
                    0.06619171798229218,
                    -0.06983707845211029,
                    -0.14182274043560028,
                    -0.05022026598453522,
                    -0.24619394540786743,
                    -0.2565918564796448,
                    0.12987878918647766,
                    -0.20556125044822693,
                    -0.04181410372257233,
                    -0.16579516232013702,
                    -0.03905942291021347,
                    -0.018639005720615387,
                    0.04447878897190094,
                    -0.1173490434885025,
                    0.15757526457309723,
                    0.011384610086679459,
                    0.630323052406311,
                    0.10656379163265228,
                    0.3593007028102875,
                    0.03222838416695595,
                    0.0706481784582138,
                    -0.002599712461233139,
                    0.16883531212806702,
                    0.08190047740936279,
                    0.11557278782129288,
                    0.030223727226257324,
                    0.08217550069093704,
                    -0.042501382529735565,
                    0.43438759446144104,
                    -0.1445169895887375,
                    0.01387544721364975,
                    -0.26635879278182983,
                    -0.051158033311367035,
                    -0.023236554116010666,
                    -0.12051297724246979,
                    -0.07421517372131348,
                    0.1568002998828888,
                    -0.0912320613861084,
                    -0.19555233418941498,
                    -0.1972118616104126,
                    0.19672560691833496,
                    0.06743445247411728,
                    -0.18326304852962494,
                    -0.26520437002182007,
                    -0.009685736149549484,
                    -0.02965768426656723,
                    -0.02548675239086151,
                    0.12778207659721375,
                    0.019132370129227638,
                    0.02460719645023346,
                    0.0714837983250618,
                    0.06278331577777863,
                    0.057431019842624664,
                    -0.16457852721214294,
                    -0.054401010274887085,
                    0.0865725576877594,
                    0.11588962376117706,
                    0.08114838600158691,
                    0.017474960535764694,
                    0.03425310552120209,
                    0.11380333453416824,
                    0.18801312148571014,
                    -0.12924376130104065,
                    0.10077591985464096,
                    0.015000872313976288,
                    -0.21969234943389893,
                    0.08612079173326492,
                    0.001016363501548767,
                    0.12506818771362305,
                    0.02113841101527214,
                    -0.016106493771076202,
                    -0.17884764075279236,
                    -0.008481651544570923,
                    -0.15056847035884857,
                    0.13324454426765442,
                    -1.3898720741271973,
                    0.057368092238903046,
                    -0.27732571959495544,
                    0.17241191864013672,
                    0.525658130645752,
                    0.21424147486686707,
                    0.0999196395277977,
                    -0.20969316363334656,
                    -0.10625864565372467,
                    0.18112967908382416,
                    -0.1083836704492569,
                    -0.028945602476596832,
                    0.03222910314798355,
                    0.03453059494495392,
                    0.143873929977417,
                    -0.25493308901786804,
                    -0.08088694512844086,
                    -0.30663564801216125,
                    -1.1186294555664062,
                    0.24276980757713318,
                    0.19881810247898102,
                    0.07510644197463989,
                    0.10756199806928635,
                    0.36578065156936646,
                    0.12003906071186066,
                    0.19313716888427734,
                    0.3000553846359253,
                    -0.08327721804380417,
                    0.12291033565998077,
                    -0.12465955317020416,
                    0.01641245372593403,
                    0.1458924114704132,
                    0.03180263936519623,
                    0.15724031627178192,
                    -0.3292364180088043,
                    0.17615388333797455,
                    0.2703085243701935,
                ],
            ),
            (
                "roberta-base",
                "This is a test text.",
                TokenInfo(5, 9),
                np.array(
                    [
                        1.60152849e-01,
                        1.07763402e-01,
                        6.98491521e-02,
                        -1.12000294e-02,
                        2.10703410e-01,
                        6.16567969e-01,
                        -9.14536454e-02,
                        -1.13923412e-01,
                        1.33676954e-01,
                        7.91762583e-02,
                        1.24274939e-03,
                        3.97298299e-01,
                        2.01541111e-01,
                        2.02541854e-01,
                        2.26355456e-01,
                        -6.38639927e-01,
                        1.85636699e-01,
                        -3.83615747e-01,
                        2.22380683e-01,
                        1.79645494e-02,
                        -9.93088763e-02,
                        4.80443269e-01,
                        7.40777738e-02,
                        -2.10073683e-02,
                        -3.71481940e-01,
                        4.46618080e-01,
                        -1.30744189e-01,
                        -1.52294211e-01,
                        -3.14043730e-01,
                        -9.15943012e-02,
                        -9.50664133e-02,
                        1.88028660e-01,
                        2.45391957e-01,
                        1.74447969e-01,
                        -2.06008084e-01,
                        1.49280049e-01,
                        -1.01988219e-01,
                        4.49552462e-02,
                        3.68282398e-01,
                        3.55792968e-02,
                        3.18991318e-02,
                        -3.22427049e-01,
                        -2.45976172e-01,
                        -6.51452318e-02,
                        8.84104837e-02,
                        -9.92641952e-02,
                        8.09612013e-02,
                        1.21164396e-02,
                        -5.13526853e-02,
                        -1.35865308e-01,
                        -7.86634870e-02,
                        1.43995546e-01,
                        -1.12482768e-01,
                        2.45668985e-01,
                        7.13330004e-02,
                        2.48758923e-02,
                        2.05728985e-01,
                        -1.22586500e-01,
                        -1.11497954e-01,
                        -3.97843719e-02,
                        2.09656358e-03,
                        -4.25161079e-01,
                        -2.29413558e-01,
                        1.48471728e-01,
                        1.50745369e-01,
                        -3.34813803e-01,
                        2.53563300e-01,
                        1.05483245e-01,
                        -2.11626764e-01,
                        2.87424233e-02,
                        -2.31766596e-01,
                        2.92342100e-02,
                        -1.44982956e-01,
                        -2.53747120e-01,
                        9.10777301e-02,
                        -8.39559510e-02,
                        4.40362394e-01,
                        -6.80793738e00,
                        -3.22629794e-01,
                        3.13193768e-01,
                        -7.34638460e-02,
                        8.46698247e-02,
                        3.59297747e-01,
                        7.63543546e-02,
                        -5.42990472e-02,
                        -4.04815733e-01,
                        2.96125010e-01,
                        7.50375539e-02,
                        7.70404702e-02,
                        -5.57629988e-02,
                        -1.82750247e-01,
                        2.71831006e-02,
                        7.94052482e-02,
                        -4.09359768e-01,
                        1.06297586e-01,
                        -1.77893333e-01,
                        -1.76376052e-01,
                        9.00936246e-01,
                        -3.53998598e-02,
                        -2.52834827e-01,
                        -2.09799208e-01,
                        -1.52427308e-01,
                        2.62218516e-01,
                        1.98813356e-01,
                        -5.79506904e-03,
                        1.35000914e-01,
                        1.34553619e-01,
                        -4.76834923e-02,
                        -3.80068235e-02,
                        5.63299712e-02,
                        3.30330476e-01,
                        4.30211678e-01,
                        1.48008894e-01,
                        1.01295620e-01,
                        7.09894095e-02,
                        -6.95995130e-02,
                        3.22553843e-01,
                        1.38364408e-01,
                        4.82426025e-02,
                        2.56576613e-01,
                        -2.08598018e-01,
                        3.18531469e-02,
                        -7.28046559e-02,
                        -3.95158380e-02,
                        2.22622700e-01,
                        -8.01816732e-02,
                        1.18114017e-01,
                        6.57051448e-02,
                        -2.48490097e-02,
                        3.21477026e-01,
                        9.43313204e-02,
                        -1.16117442e00,
                        -1.44041125e-02,
                        -4.03817296e-02,
                        1.71989195e-01,
                        1.30256377e-01,
                        -9.54966173e-02,
                        3.28441281e-02,
                        -6.49246834e-02,
                        -1.27854832e-01,
                        4.56262268e-02,
                        -5.28171994e-02,
                        2.57084832e-01,
                        1.84375718e-02,
                        4.55335259e-01,
                        1.35112341e-01,
                        -4.13085259e-02,
                        -2.50359215e-02,
                        -6.06350973e-02,
                        -3.40551818e-02,
                        2.18182877e-01,
                        1.48332268e-02,
                        7.99562391e-02,
                        6.27343096e-02,
                        -2.92206407e-02,
                        4.78282794e-01,
                        -1.68542445e-01,
                        2.67018378e-03,
                        2.83520535e-01,
                        4.77563322e-01,
                        2.30449028e-01,
                        -1.27054673e-01,
                        5.74519247e-01,
                        -1.88251227e-01,
                        4.42398265e-02,
                        9.59845409e-02,
                        -1.72062419e-01,
                        -2.45225914e-01,
                        -3.31389368e-01,
                        1.39501657e-01,
                        -2.06150793e-01,
                        2.58456953e-01,
                        3.49464044e-02,
                        -1.67425230e-01,
                        -1.87913418e-01,
                        5.68587668e-02,
                        2.60640934e-01,
                        2.45492093e-01,
                        -5.33363596e-03,
                        3.44455242e-02,
                        6.00265190e-02,
                        8.24081451e-02,
                        9.76806115e-02,
                        -1.18889183e-01,
                        2.21596491e-02,
                        1.74218558e-01,
                        3.85063395e-01,
                        2.52130445e-01,
                        -2.04159759e-01,
                        1.51846923e-01,
                        1.77747458e-01,
                        2.86338307e-01,
                        -1.85516022e-01,
                        5.08934781e-02,
                        1.69499546e-01,
                        9.29286070e-02,
                        -1.71052655e-02,
                        1.41572520e-01,
                        1.69851288e-01,
                        -1.63998820e-01,
                        -1.08216997e-01,
                        -8.53277277e-02,
                        5.97924404e-02,
                        2.59610832e-01,
                        -2.61540879e-02,
                        -1.32429369e-01,
                        -2.06024967e-01,
                        -1.76364668e-02,
                        2.28223160e-01,
                        -8.11460209e-02,
                        -2.66873054e-02,
                        1.94908440e-01,
                        -8.48581735e-02,
                        9.05536339e-02,
                        -2.84312509e-01,
                        9.71177872e-02,
                        -4.10520788e-02,
                        -4.43521827e-01,
                        4.59692106e-01,
                        4.33088586e-01,
                        1.58866534e-01,
                        1.89539276e-01,
                        -1.93279102e-01,
                        -2.87079252e-02,
                        -2.10938953e-01,
                        7.55549073e-02,
                        2.25049615e-01,
                        -2.67364740e-01,
                        2.12626010e-02,
                        3.34505081e-01,
                        -6.07641414e-03,
                        9.72837210e-03,
                        -1.07557796e-01,
                        -5.63628413e-02,
                        2.04782948e-01,
                        -2.36218490e-01,
                        1.33958053e-01,
                        2.63509698e-01,
                        -2.56904848e-02,
                        -1.00978995e-01,
                        -2.60114789e-01,
                        6.19045068e-02,
                        -1.26888506e-01,
                        -6.72157928e-02,
                        -1.41613424e-01,
                        -5.49622908e-01,
                        2.18580849e-02,
                        1.87516578e-01,
                        1.78406321e-01,
                        8.02055001e-04,
                        -1.29204877e-02,
                        -5.50795253e-02,
                        2.09234647e-01,
                        -1.02681667e-03,
                        1.72068876e-01,
                        -2.24891663e-01,
                        -2.05064368e-01,
                        -1.20093960e-01,
                        -2.24030990e-01,
                        2.60689907e-01,
                        -2.62925826e-01,
                        -1.30101122e-01,
                        4.62062314e-01,
                        -2.32047714e-01,
                        7.35203680e-02,
                        2.14640614e-01,
                        -1.16099697e-01,
                        1.28336268e-01,
                        2.96705365e-02,
                        2.97106840e-02,
                        -1.08568329e-01,
                        6.45536389e-02,
                        1.05170939e-01,
                        -1.47640966e-02,
                        -3.92137542e-02,
                        -1.02637060e-01,
                        1.28967084e-01,
                        -1.37233771e-01,
                        2.66821623e-01,
                        5.73370121e-02,
                        2.52196789e-01,
                        -2.99460724e-01,
                        8.67802799e-02,
                        -9.49830636e-02,
                        9.33495872e-02,
                        7.57103022e-02,
                        -2.47735411e-01,
                        9.30555500e-02,
                        -4.71913703e-02,
                        -5.20680249e-02,
                        2.39566371e-01,
                        -1.16313547e-02,
                        -8.62887911e-02,
                        -8.69750939e-02,
                        -4.36396468e-02,
                        -8.84971395e-02,
                        6.33248203e-02,
                        -4.39712211e-01,
                        3.16648573e-01,
                        8.79971460e-02,
                        8.35488774e-02,
                        3.70815635e-01,
                        1.99000180e-01,
                        -4.23871465e-02,
                        -3.04435492e-01,
                        -2.41274208e-01,
                        -6.94249365e-02,
                        1.05477195e-01,
                        -1.79286085e-01,
                        2.01357510e-02,
                        1.96486205e-01,
                        -4.60609317e-01,
                        -4.13985793e-02,
                        1.13196533e-01,
                        3.82218538e-02,
                        -1.14080880e-01,
                        2.60497279e-01,
                        3.24779302e-01,
                        6.30458221e-02,
                        -2.57175967e-01,
                        1.27872363e-01,
                        2.35130079e-02,
                        -2.48898819e-01,
                        2.90421005e-02,
                        1.14873921e-01,
                        4.71745990e-02,
                        -3.45817730e-01,
                        -3.75043005e-02,
                        2.95620069e-01,
                        1.54997692e-01,
                        1.10893410e00,
                        1.70875531e00,
                        2.34384783e-01,
                        -7.51007237e-02,
                        8.64659995e-02,
                        2.66930312e-02,
                        -1.68291152e-01,
                        1.83746442e-02,
                        1.68971337e-01,
                        1.63387639e-01,
                        -7.38261379e-02,
                        -7.94223808e-02,
                        -3.47267240e-01,
                        -3.69317327e-02,
                        2.26311252e-01,
                        6.27005138e-02,
                        1.60596043e-01,
                        -4.37598787e-02,
                        1.45183742e-01,
                        -3.41163512e-01,
                        -2.52578437e-01,
                        -2.35747248e-01,
                        6.46363050e-02,
                        7.80303665e-02,
                        -2.47749183e-02,
                        -4.65646967e-01,
                        1.30591858e-01,
                        2.53760889e-02,
                        -1.24963518e-01,
                        3.73300806e-01,
                        4.14936781e-01,
                        5.13453916e-01,
                        1.58638924e-01,
                        -2.02942044e-01,
                        -3.00377280e-01,
                        4.27993417e-01,
                        2.61635303e-01,
                        1.85452014e-01,
                        -4.49450761e-02,
                        -1.20162688e-01,
                        1.45639315e-01,
                        -2.01895759e-02,
                        -2.17845701e-02,
                        -1.73658391e-01,
                        1.18244756e-01,
                        -1.63184851e-02,
                        4.00322646e-01,
                        -1.50818154e-01,
                        9.11268592e-03,
                        -3.93357798e-02,
                        -1.75804898e-01,
                        1.39289010e-01,
                        -2.11993724e-01,
                        -8.44966732e-02,
                        1.36404039e-01,
                        1.85709804e-01,
                        -1.63355442e-01,
                        -9.55905318e-02,
                        7.33690187e-02,
                        1.56556936e-02,
                        1.54331876e-01,
                        6.28872383e-02,
                        -1.83347218e-01,
                        3.42950761e-01,
                        1.14188949e-01,
                        2.10709073e-01,
                        -4.49028984e-02,
                        -8.47163931e-01,
                        3.30973551e-01,
                        -1.39261140e-02,
                        -9.20554623e-03,
                        -7.43761808e-02,
                        1.63577307e-01,
                        4.52001378e-01,
                        -2.34469377e-01,
                        -4.60598692e-02,
                        9.13189128e-02,
                        -2.46551841e-01,
                        -9.95365530e-03,
                        5.27357683e-04,
                        -9.37325135e-03,
                        -1.77924506e-01,
                        1.44738972e-01,
                        -9.69652832e-02,
                        -7.00267758e-02,
                        -6.66223802e-02,
                        3.69586483e-01,
                        9.03344876e-02,
                        -2.64510788e-01,
                        6.18129261e-02,
                        -4.94595945e-01,
                        5.08541632e-02,
                        -5.92307746e-03,
                        6.09166697e-02,
                        -3.88376415e-03,
                        2.62840621e-01,
                        -8.34400877e-02,
                        -9.26935971e-02,
                        -5.74841965e-02,
                        -7.70850070e-02,
                        -2.55587764e-01,
                        3.63216735e-02,
                        2.13036343e-01,
                        6.94601089e-02,
                        -1.33977994e-01,
                        -1.15050871e-01,
                        5.73921353e-02,
                        -2.08163634e-04,
                        2.23419547e-01,
                        -6.87950710e-02,
                        -4.26478516e-02,
                        -1.35094181e-01,
                        6.91670850e-02,
                        3.08886766e-02,
                        2.72022914e-02,
                        9.02921893e-03,
                        -2.86621347e-01,
                        1.33163730e-01,
                        2.64753938e-01,
                        -2.44022474e-01,
                        -1.23592189e-01,
                        4.90617156e-02,
                        -3.90163168e-01,
                        -1.72047007e00,
                        -5.17533459e-02,
                        1.68563619e-01,
                        1.29414819e-01,
                        5.35897352e-02,
                        -2.05109060e-01,
                        -4.24678661e-02,
                        -1.26579061e-01,
                        1.79908335e-01,
                        -1.88575462e-02,
                        -2.67037330e-02,
                        -1.59060154e-02,
                        -2.83341534e-01,
                        5.87900765e-02,
                        2.42489479e-01,
                        2.95261160e-01,
                        4.07057270e-01,
                        9.48320571e-02,
                        -4.37232312e-02,
                        -3.33314398e-02,
                        -4.83248770e-01,
                        4.74519283e-03,
                        6.68696389e-02,
                        3.32604311e-02,
                        2.18218528e-01,
                        4.82063875e-01,
                        2.23677218e-01,
                        1.62077986e-01,
                        -1.52314857e-01,
                        -3.63486726e-02,
                        -4.85713780e-03,
                        -1.25367939e-01,
                        5.47435135e-02,
                        1.29437134e-01,
                        1.02393076e-01,
                        3.55063222e-01,
                        -3.02847642e-02,
                        2.37722009e-01,
                        -3.31701130e-01,
                        2.12438531e-01,
                        1.64324194e-01,
                        1.49407029e-01,
                        -1.31975692e-02,
                        -1.33739758e00,
                        -2.02768147e-02,
                        -1.54827788e-01,
                        7.12065902e-02,
                        -8.43051672e-02,
                        1.54995658e-02,
                        7.47667402e-02,
                        5.35365883e-02,
                        2.45000847e-01,
                        7.21155666e-02,
                        -2.49082327e-01,
                        4.86062560e-02,
                        2.42370419e-01,
                        -3.59251415e-02,
                        1.17390787e-01,
                        -2.60605648e-01,
                        4.40248288e-02,
                        7.95768052e-02,
                        -1.49491668e-01,
                        1.36494735e-01,
                        1.34722065e-01,
                        -8.20601359e-03,
                        2.04192553e-01,
                        -2.94322006e-01,
                        -1.22914009e-01,
                        1.41118858e-02,
                        -2.29305506e-01,
                        9.79992561e-02,
                        3.74265730e-01,
                        1.34007200e-01,
                        -3.12192902e-01,
                        -1.30246691e-01,
                        2.94812858e-01,
                        -1.96638025e-01,
                        -2.52448171e-02,
                        -1.32938862e-01,
                        4.63966206e-02,
                        -4.64749970e-02,
                        -3.88761133e-01,
                        -1.17839076e-01,
                        -2.28864387e-01,
                        8.76645306e-02,
                        -8.23439527e-02,
                        -1.73116498e-01,
                        1.34454813e-01,
                        -1.31950222e-01,
                        2.91950487e-01,
                        1.61115792e-01,
                        1.29192144e-01,
                        -1.17973026e-01,
                        7.96334669e-02,
                        -2.69294247e-01,
                        1.31482095e-01,
                        7.76036084e-03,
                        2.61252895e-02,
                        -2.91625708e-01,
                        2.03498334e-01,
                        2.10726850e-01,
                        7.48493867e-02,
                        -1.38888799e-01,
                        1.50859840e-02,
                        -8.21670853e-02,
                        -2.94702321e-01,
                        2.70634204e-01,
                        1.98813461e-01,
                        4.30018678e-02,
                        -3.46066967e-01,
                        -1.10929884e-01,
                        -1.50445402e-02,
                        2.94112600e-02,
                        -7.59271160e-03,
                        1.61037967e-03,
                        2.25714006e-01,
                        5.04977442e-02,
                        -6.03355944e-01,
                        -1.26684994e-01,
                        2.34013887e-01,
                        -3.57218146e-01,
                        4.59756330e-02,
                        3.22825063e-01,
                        7.14217387e-02,
                        1.43109221e-01,
                        -2.74837915e-01,
                        -6.20524660e-02,
                        -2.80286968e-01,
                        -1.05581075e-01,
                        -4.86709103e-02,
                        -9.49778818e-02,
                        1.34180158e-01,
                        3.70471150e-01,
                        -3.06426913e-01,
                        2.27067262e-01,
                        1.10594463e01,
                        -7.87569061e-02,
                        -9.19135101e-02,
                        5.92842996e-02,
                        -1.28214281e-01,
                        8.58925954e-02,
                        8.83935075e-02,
                        1.61208263e-01,
                        -1.29230104e-01,
                        2.28646420e-01,
                        1.69555139e-01,
                        2.37206906e-01,
                        -2.15410648e-02,
                        -9.03245620e-02,
                        -3.16832811e-02,
                        -2.00280398e-01,
                        1.46621220e-01,
                        -1.52289309e-01,
                        -1.77272238e-01,
                        -7.60535561e-02,
                        -2.24437013e-01,
                        3.26524392e-01,
                        2.38788567e-01,
                        3.69146973e-01,
                        -2.55368799e-02,
                        1.93992294e-02,
                        -7.28718713e-02,
                        -5.11605293e-03,
                        5.51456586e-02,
                        -1.12806447e-01,
                        -2.86981732e-01,
                        -1.26507975e-01,
                        -2.49165371e-02,
                        -6.85957298e-02,
                        5.22025377e-02,
                        3.58120501e-01,
                        2.22902572e-01,
                        6.98086470e-02,
                        -1.28115654e-01,
                        -1.99783579e-01,
                        6.24825433e-03,
                        6.90225791e-02,
                        2.37558596e-02,
                        1.51432082e-01,
                        3.82907018e-02,
                        -3.36922426e-03,
                        8.75408389e-02,
                        2.35240050e-01,
                        4.18039896e-02,
                        1.27563182e-01,
                        -9.36200209e-02,
                        7.55711123e-02,
                        4.92044259e-02,
                        4.28404450e-01,
                        -2.24385828e-01,
                        -2.84904521e-03,
                        -6.90794364e-03,
                        1.02180924e-01,
                        1.63222969e-01,
                        -3.06143694e-01,
                        2.80926839e-01,
                        9.55228992e-02,
                        1.50478519e-01,
                        3.09663162e-01,
                        3.68990153e-01,
                        1.99845895e-01,
                        -5.22326790e-02,
                        -3.71474568e-02,
                        -1.27323799e-01,
                        -7.46930391e-02,
                        -1.23129621e-01,
                        6.09670766e-03,
                        -1.77190989e-01,
                        -1.03382796e-01,
                        1.40060201e-01,
                        -2.50149205e-01,
                        -9.19264629e-02,
                        -2.16788664e-01,
                        -8.89294110e-02,
                        -1.67619284e-01,
                        3.70251685e-02,
                        -2.35482916e-01,
                        1.77083448e-01,
                        8.65023956e-03,
                        4.95990098e-01,
                        1.39525484e-01,
                        3.53299126e-01,
                        -3.44128720e-02,
                        5.94892092e-02,
                        1.23832887e-02,
                        7.85316806e-02,
                        1.46819353e-02,
                        1.38578527e-02,
                        3.83109422e-02,
                        1.58877641e-01,
                        -6.81881905e-02,
                        5.60795635e-01,
                        -2.85594024e-01,
                        -1.82080958e-02,
                        -1.61586903e-01,
                        -9.03840996e-02,
                        -4.25334424e-02,
                        -8.22293870e-02,
                        -1.08805947e-01,
                        2.50702344e-01,
                        -1.54801272e-01,
                        -6.19280711e-02,
                        -2.64036819e-01,
                        3.19797739e-01,
                        7.14176409e-02,
                        -7.71096600e-02,
                        -1.99036084e-01,
                        7.12668169e-02,
                        -7.65307471e-02,
                        5.05965054e-02,
                        9.68631357e-02,
                        4.49999953e-02,
                        1.00365878e-01,
                        1.58448186e-01,
                        -1.53399892e-02,
                        -8.50678049e-03,
                        -1.47409879e-01,
                        6.16459921e-03,
                        1.59390312e-01,
                        1.56486750e-01,
                        1.53388124e-01,
                        1.14590321e-02,
                        -1.14910414e-01,
                        1.69132255e-01,
                        2.55680904e-01,
                        -3.28266993e-02,
                        7.52376933e-02,
                        -1.19848851e-01,
                        -2.24935442e-01,
                        8.52380842e-02,
                        3.05174030e-02,
                        8.96174051e-02,
                        7.43984617e-03,
                        -7.93562792e-02,
                        -1.32303432e-01,
                        7.27897231e-03,
                        -5.53547703e-02,
                        2.38324329e-01,
                        -1.30778253e00,
                        1.04412321e-01,
                        -3.92463133e-01,
                        2.05766685e-01,
                        1.75347485e-01,
                        2.12434977e-01,
                        3.99721526e-02,
                        -2.41557345e-01,
                        -1.58632889e-01,
                        2.06255972e-01,
                        -2.73069702e-01,
                        -7.15494938e-02,
                        1.02291906e-01,
                        3.40773966e-02,
                        1.09341249e-01,
                        -3.40450719e-01,
                        -6.99948557e-02,
                        -2.05646463e-01,
                        -7.02013060e-01,
                        2.95226574e-01,
                        1.60883788e-01,
                        2.68787514e-01,
                        2.76615024e-02,
                        2.98634678e-01,
                        4.04316895e-02,
                        9.14692543e-02,
                        1.96745578e-01,
                        -1.58848431e-01,
                        1.42013222e-01,
                        -2.42494322e-01,
                        4.84607024e-02,
                        1.23719301e-01,
                        -5.41557930e-03,
                        2.71233678e-01,
                        -2.25402959e-01,
                        1.56972744e-01,
                        4.38961491e-01,
                    ]
                ),
            ),
        ],
    )
    def test_token_embedding(self, model_name, text, char_span, expected):
        assert RobertaModelWrapper.from_pretrained(model_name).token_embedding(
            Passage(text), char_span
        ) == pytest.approx(expected, abs=1e-3)

    @pytest.mark.parametrize(
        "model_name, corpus",
        [
            ("roberta-base", Corpus()),
            ("roberta-base", Corpus.from_lines(["This is a test."])),
            ("roberta-base", Corpus({Passage("This is a test."): {TokenInfo(0, 4)}})),
            (
                "roberta-base",
                Corpus(
                    {Passage("This is a test."): {TokenInfo(0, 4), TokenInfo(5, 7)}}
                ),
            ),
        ],
    )
    def test_add_embeddings(self, model_name, corpus):
        RobertaModelWrapper.from_pretrained(model_name).add_embeddings(corpus)
        for token_info in corpus.token_infos:
            assert token_info.embedding is not None
